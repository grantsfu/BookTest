# APP端可编程平台实现可参考资料
小车的硬件平台已基本搭建完成。接下来很大的一部分工作需要放到小车固件开发和APP端编程平台搭建上，两者基于自定义协议通讯，相辅相成组成一套完整的小车行驶系统。
![](/assets/APP平台-1.PNG)
## 固件开发
以小车所要实现的功能为导向，主要需要实现如下几点：
### 循迹功能
循迹由4路光电传感实现，中间的两路间隔距离为匹配市面上黑胶带常用的宽度12MM制定，外边的两路是为了小车循迹效果可以更平滑而设定
- 循迹需要做两种类型的功能，一种是一键循迹功能，即小车在接收到相关指令后立即开始自动循迹；另一种是把实现循迹所需要用到的几种关键功能封装成可供协议调用的API，在APP端编程平台体现为相对应的积木模块，由玩家自行把这些控制硬件模块的积木和编程平台的一些负责逻辑功能的模块组合起来，实现玩家自定义的循迹功能。

![](/assets/循迹-积木现实.PNG)
图、积木实现自定义循迹（部分积木） VS 自动循迹

Number | Block | Specification
-------| ------| -------------
1      | 自动循迹 | 固件内实现，4路循迹传感器采集数据
表格、自动循迹积木

Number | Block | Specification
-------| ------| -------------
1      | 当左边内侧循迹传感器检测到黑线 | 利用内侧两传感器实现简单循迹
2      | 当右边内侧循迹传感器检测到黑线 | 同上，通过这些模块可让学生了解实现循迹的基本原理
表格、拆分出的、可供玩家自定义的循迹积木

### 避障功能
避障模块由两部分组成，一个是置于小车前脸的超声波测距模块，另一个是靠近小车前端两侧的红外光电开关。这样小车可同时具备检测前方，左侧以及右侧障碍物的能力。
![](/assets/小车-避障系统.PNG)
- 和循迹类似，避障也需要做两种类型的功能，一种是自动避障功能，另一种是把避障拆分成几个独立的功能模块。自动避障的输入有三个，一个是前脸超声波模块检测到的距离，一个是左侧避障传感器输出的数字信号（高低电平），还有一个是右侧避障传感器输出的数字信号。根据这三种输入的数据，结合一定的逻辑或算法（未定），以小车的前后左右行驶作为输出，可以实现简单的避障功能。
Number | Block | Specification
------ | ----- | -------------
1      | 自动避障 | 由系统实现避障功能，小车固件内
- 另一方面，由于小车左右两侧的避障模块具备了距离检测的功能，即模拟信号输出，复杂一些的避障实现可以把3个维度的输入上升到5个维度，在原有3个输入的基础上添加左右两侧传感器输出的模拟信号。需要注意的是，受ST188传感器自身感应能力的限制，改良的避障功能效果可能并不明显。
- 至于把避障拆分成几个独立的功能模块，可以考虑为避障定义如下几个积木：
Number | Block                        | Specification
-------| ----------------------------- | ----------------
1      | 超声波检测到前方（参数1）M有障碍物 | 参数1精确到小数点后1位
2      | 左侧方传感器检测到障碍物（参数2） | 参数2为boolean值,即True/False
3      |右侧方传感器检测到障碍物（参数3）| 参数3，True/False

此部分的积木模块具有输出值，这些值是由小车端传感器采集到后经过一定处理再传输给APP端平台的，可以利用这些数据做一些交互。以超声波传感器为例，把检测到的障碍物距离值作为应用输入，调节一个精灵的尺寸大小作为应用输出，当距离值越小时，精灵的头越大，且发出惨烈的尖叫声；当距离值越大时，精灵的头越小，且发出愉快的哼唱声。

### 光照强度检测
环境光感应传感器将按照一定的频率（频率未定）返回一个模拟值，该值随环境光线强弱的变化而变化（线性）。在APP端的积木体现为返回具体的阶梯等级，分两个版本：

#### 幼儿版

Number | Block | Specification
- | - | -
1 | 当环境光线（参数1）时 | 参数1的值为阶梯值，分3个等级，分别为强、正常、弱
表格、光照检测积木（幼儿版）

由于传感器返回的是一系列的模拟值，且该值随光线强弱线性变化，因此需要把线性区间分为3个区域（不一定是等分），每个区域都有对应的临界值，把获取到的当前光照强度数据和这些临界值进行比较，获得该值所对应的区间，返回给APP。

#### 少儿版

Number | Block | Specification
- | - | -
1 | 当环境光线（参数1）时 | 参数1的值为阶梯值，分7个等级，即极强、很强、较强、正常、较弱、很弱、极弱
表格、光照检测积木（少儿版）

- 和幼儿版的类似，只是细化了光强的区分，此时需要把线性区域分为7个区间（不一定是等分）。细化意味着可以用该积木做更加复杂的交互。假如当前应用场景为：通过光线检测积木获取到的数据（应用输入）来调节一天24小时的变化（可在APP端编程平台设计不同场景，作为该应用的输出）。幼儿版的只能做到早（光线正常）、中（光线强）、晚（光线弱）三个场景的自动切换，而少儿版将可做到7个应用场景的切换，如可增加黎明、上午、下午、黄昏四个场景。当然前提是APP端要有一些必要的支撑积木，如条件判断，延时等，以及相对应的场景素材。

### 小车声音系统

声音系统可分为两部分，一部分为完全植入固件内的，无参数可配置，另一部分也植入固件内，但是预留了可接收玩家配置参数的API，为可定制部分。

为APP端提供如下的调用可能：

Number | Block | Specification
- | - | -
1 | 插播语音（参数1） | 参数1为可供选择的语音片段，如早上好
2 | 插播歌曲（参数1） | 参数1为可供选择的歌曲片段，如生日歌

可供选择的语音片段和歌曲片段，具体可根据小车想要展示的风格来定，如少女声，少男声，或者是和BB-8类似的非自然语言音。时间允许可以多做几个不同的版本供玩家自己选择，小车主板上提供了可更新MP3文件的Micro USB接口。这些要表达的不同风格都是由不同的录音文件所决定的，但他们的声音系统可以是一致的，什么时候该发音，发音的控制机制可以是一致的，下面是草拟的一个发音机制：
![](/assets/声音系统.PNG)

### 小车灯光系统

灯光系统由两部分组成，一部分是负责LOGO灯效的单个RGB LED，另一部分是置于小车底部的四盏LED。这两部分是相互独立的，由不同的IO口驱动。底部四盏LED虽然是由同一个IO口驱动，但是每盏LED也是可以被单独控制的。以下是小车灯光系统的设计图：
![](/assets/灯光系统.PNG)

可配置的部分即APP端展示给玩家的积木模块，如下：

Number | Block | Specification
- | - | -
1 | LOGO LED亮度（参数1），颜色（参数2） | 参数1为数个可选的亮度等级，参数2为数个可选的颜色
2 | LOGO LED呼吸灯，颜色（参数1） | 参数1可供选择的颜色库和其他积木是一致的
3 | 底部四LED亮度（参数1），颜色（参数2） | 系统内各模块的亮度等级和颜色库是一致的
4 | 底部四LED呼吸灯，颜色（参数1） | 同上
5 | 底部LED1颜色（参数1），LED2颜色（参数2），LED3颜色（参数3），LED颜色（参数4） | 四个参数的颜色库和其他积木一致，亮度为固定值

### 小车基本行驶

小车在刚开机的时候是不行驶的，只有在APP端积木程序开始运行时，包含对小车电机的操作积木以后，才会做相对应的行驶，可操作的积木如下：

Number | Block | Specification
- | - | -
01 | 保持向前行驶 | 无参数，以一固定速度向前行驶
02 | 保持向后行驶 | 无参数，以一固定速度向后行驶
03 | 保持向左旋转 | 无参数，以一固定速度向左旋转
04 | 保持向右旋转 | 无参数，以一固定速度向右旋转
05 | 停止行驶 | 无参数，小车停止不动
06 | 以（参数1）PWM速度向前行驶 | 参数1，范围（？~255），？为一个可以让小车正常低速向前行驶的值
07 | 以（参数1）PWM速度向后行驶 | 参数1，范围（？~255），？为一个可以让小车正常低速向后行驶的值
08 | 左轮以（参数1）PWM速度（参数2）转动 | 参数1，范围（？~255），？意义同上；参数2，取向前/向后
09 | 右轮以（参数1）PWM速度（参数2）转动 | 参数1，范围（？~255），？意义同上；参数2，取向前/向后
10 | 向左旋转（参数1）度 | 参数1，分4个梯度，分别为45°，90°，135°，180°
11 | 向右旋转（参数1）度 | 参数1，分4个梯度，分别为45°，90°，135°，180°

利用以上的积木块，结合APP端平台提供的一些逻辑积木块，可以实现各种自定义动作。

### 电源管理

只需要一点，检测到电源电压低于某个既定值时（具体值需要测试后才能得到），发送给小车系统，让其作出相对应的提示让玩家知道即可。

### 蓝牙连接

和电源管理一样，也是起到一个提示的作用。当蓝牙成功连接、断开状态时都能有相应的提示（提示方式在小车灯光系统和声音系统中有说明）。

### 总结

总体来说，小车固件可以作出如下的划分：
![](/assets/小车固件.PNG)

整理了一份小车APP端所有积木的表格：

Number | Block | Specification
- | - | -
01 | 自动循迹 | 固件内实现，4路循迹传感器采集数据
02 | 当左边内侧循迹传感器检测到黑线 | 利用内侧两传感器实现简单循迹
03 | 当右边内侧循迹传感器检测到黑线 | 同上，通过这些模块可让学生了解实现循迹
04 | 自动避障 | 由系统实现避障功能，小车固件内
05 | 超声波检测到前方（参数1）M有障碍物 | 参数1精确到小数点后1位
06 | 左侧方传感器检测到障碍物（参数2） | 参数2为boolean值,即True/False
07 |右侧方传感器检测到障碍物（参数3）| 参数3，True/False
08 | 当环境光线（参数1）时 | 参数1的值为阶梯值，分3个等级，分别为强、正常、弱
09 | 当环境光线（参数1）时 | 参数1的值为阶梯值，分7个等级，即极强、很强、较强、正常、较弱、很弱、极弱
10 | 插播语音（参数1） | 参数1为可供选择的语音片段，如早上好
11 | 插播歌曲（参数1） | 参数1为可供选择的歌曲片段，如生日歌
12 | LOGO LED亮度（参数1），颜色（参数2） | 参数1为数个可选的亮度等级，参数2为数个可选的颜色
13 | LOGO LED呼吸灯，颜色（参数1） | 参数1可供选择的颜色库和其他积木是一致的
14 | 底部四LED亮度（参数1），颜色（参数2） | 系统内各模块的亮度等级和颜色库是一致的
15 | 底部四LED呼吸灯，颜色（参数1） | 同上
16 | 底部LED1颜色（参数1），LED2颜色（参数2），LED3颜色（参数3），LED颜色（参数4） | 四个参数的颜色库和其他积木一致，亮度为固定值
17 | 保持向前行驶 | 无参数，以一固定速度向前行驶
18 | 保持向后行驶 | 无参数，以一固定速度向后行驶
19 | 保持向左旋转 | 无参数，以一固定速度向左旋转
20 | 保持向右旋转 | 无参数，以一固定速度向右旋转
21 | 停止行驶 | 无参数，小车停止不动
22 | 以（参数1）PWM速度向前行驶 | 参数1，范围（？~255），？为一个可以让小车正常低速向前行驶的值
23 | 以（参数1）PWM速度向后行驶 | 参数1，范围（？~255），？为一个可以让小车正常低速向后行驶的值
24 | 左轮以（参数1）PWM速度（参数2）转动 | 参数1，范围（？~255），？意义同上；参数2，取向前/向后
25 | 右轮以（参数1）PWM速度（参数2）转动 | 参数1，范围（？~255），？意义同上；参数2，取向前/向后
26 | 向左旋转（参数1）度 | 参数1，分4个梯度，分别为45°，90°，135°，180°
27 | 向右旋转（参数1）度 | 参数1，分4个梯度，分别为45°，90°，135°，180°











